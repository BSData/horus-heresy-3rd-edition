name: comment-on-merge.yml
on: pull_request
jobs:
  Summarize:
    runs-on: ubuntu-latest
    steps:
      - name: Checking out game system
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setting up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install GitPython
        run: pip install GitPython
      - name: Checking out BSCopy
        uses: actions/checkout@v4
        with:
          repository: 'nstephenh/bscopy'
          path: 'tests/BSCopy'
      - name: Summarize changes
        id: summarize
        run: |
          MERGE_BASE=$(git merge-base ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo $MERGE_BASE
          python3 BSCopy/reporting_scripts/diff_test.py -merge_base $MERGE_BASE
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "SUMMARY<<${EOF}"
            cat diff_result.txt
            echo "\n"
            echo "${EOF}"
          } >> $GITHUB_OUTPUT
        working-directory: 'tests'
        env:
          DEFAULT_DATA_DIRECTORY: ${{ github.workspace }}/..
      - name: Comment on the PR
        uses: actions/github-script@v7
        env:
          GITHUB_OUTPUT: ${{steps.summarize.outputs.SUMMARY}}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{env.GITHUB_OUTPUT}}`
            })
